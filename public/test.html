<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Questit Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
    }
    #prompt {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    select {
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 12px;
      width: 100%;
    }
    #output {
      margin-top: 24px;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      min-height: 200px;
    }
    .error {
      color: #dc2626;
      background: #fef2f2;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h1>Questit Platform Test</h1>
  <p>Enter a prompt to generate a micro-tool:</p>

  <label for="model-select" style="display:block;font-weight:600;margin-bottom:6px;">Model</label>
  <select id="model-select">
    <option value="openai:gpt-4o-mini">OpenAI · GPT-4o mini</option>
    <option value="gemini:1.5-flash">Google · Gemini 1.5 Flash</option>
  </select>

  <input type="text" id="prompt" placeholder="e.g., Create a simple calculator" value="Create a simple calculator">
  <br>
  <button id="generate">Generate Tool</button>
  <button id="publish" disabled>Publish Tool</button>
  
  <div id="output"></div>
  <div id="error"></div>

  <script type="importmap">
    {
      "imports": {
        "questit": "../src/index.js",
        "questit/publish": "../src/core/publish.js"
      }
    }
  </script>
  <script type="module">
    // Try to import with fallback error handling
    let Questit, publishTool;
    try {
      const questitModule = await import('../src/index.js');
      Questit = questitModule.default;
      const publishModule = await import('../src/core/publish.js');
      publishTool = publishModule.publishTool;
    } catch (importError) {
      document.getElementById('error').innerHTML = `
        <div class="error">
          <strong>Import Error:</strong> ${importError.message}<br>
          <small>Make sure you're serving from the project root, not just the public folder.<br>
          Try: <code>python3 -m http.server 8000</code> from the project root, then visit <code>http://localhost:8000/public/test.html</code></small>
          <pre style="margin-top: 8px; font-size: 12px; overflow: auto;">${importError.stack}</pre>
        </div>
      `;
      throw importError;
    }

    // Initialize Sentry if available
    if (window.Sentry) {
      window.Sentry.init({
        dsn: 'YOUR_SENTRY_DSN_HERE', // Replace with actual DSN
        environment: 'production',
        tracesSampleRate: 1.0
      });
    }

    // Allow endpoint override via URL parameter or default to production
    const urlParams = new URLSearchParams(window.location.search);
    const apiEndpoint = urlParams.get('endpoint') || 'https://questit.cc/api/ai/proxy';
    const apiBase = urlParams.get('apiBase') || 'https://questit.cc/api';
    const modelMap = {
      'openai:gpt-4o-mini': { provider: 'openai', model: 'gpt-4o-mini' },
      'gemini:1.5-flash': { provider: 'gemini', model: 'gemini-1.5-flash' }
    };
    const defaultModelId = urlParams.get('model') || 'openai:gpt-4o-mini';
    const resolveModelConfig = (id) => modelMap[id] || modelMap['openai:gpt-4o-mini'];

    console.log('Using API endpoint:', apiEndpoint);
    console.log('Using API base:', apiBase);

    const modelSelect = document.getElementById('model-select');
    if (modelMap[defaultModelId]) {
      modelSelect.value = defaultModelId;
    }

    let currentModelConfig = resolveModelConfig(modelSelect.value);
    let questit = new Questit({
      endpoint: apiEndpoint,
      provider: currentModelConfig.provider,
      model: currentModelConfig.model
    });

    const promptInput = document.getElementById('prompt');
    const generateBtn = document.getElementById('generate');
    const publishBtn = document.getElementById('publish');
    const output = document.getElementById('output');
    const errorDiv = document.getElementById('error');

    let currentTool = null;

    modelSelect.addEventListener('change', () => {
      currentModelConfig = resolveModelConfig(modelSelect.value);
      questit = new Questit({
        endpoint: apiEndpoint,
        provider: currentModelConfig.provider,
        model: currentModelConfig.model
      });
      currentTool = null;
      publishBtn.disabled = true;
      errorDiv.innerHTML = '<div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-top: 12px;">Model changed. Generate a new tool to use the selected provider.</div>';
    });

    function showError(message, details = null) {
      let errorHtml = `<div class="error"><strong>Error:</strong> ${message}`;
      if (details) {
        errorHtml += `<details style="margin-top: 8px;"><summary>Details</summary><pre style="margin-top: 4px; font-size: 12px; overflow: auto;">${JSON.stringify(details, null, 2)}</pre></details>`;
      }
      errorHtml += '</div>';
      errorDiv.innerHTML = errorHtml;
    }

    generateBtn.addEventListener('click', async () => {
      const prompt = promptInput.value.trim();
      if (!prompt) {
        showError('Please enter a prompt');
        return;
      }

      generateBtn.disabled = true;
      errorDiv.innerHTML = '';
      output.innerHTML = '<p>Generating tool... This may take 30-60 seconds.</p>';

      try {
        console.log('Starting tool generation with prompt:', prompt);
        const container = await questit.process(prompt, {}, 'render');
        currentTool = questit.currentTool;
        
        if (!container) {
          throw new Error('Tool generation returned null container');
        }
        
        if (!currentTool) {
          throw new Error('Tool generation completed but currentTool is null');
        }

        output.innerHTML = '';
        output.appendChild(container);
        publishBtn.disabled = false;
        console.log('Tool generated successfully:', currentTool);
        errorDiv.innerHTML = '<div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-top: 12px;">✅ Tool generated successfully!</div>';
      } catch (error) {
        console.error('Generation error:', error);
        const errorDetails = {
          message: error.message,
          stack: error.stack,
          name: error.name,
          cause: error.cause
        };
        showError(error.message, errorDetails);
      } finally {
        generateBtn.disabled = false;
      }
    });

    publishBtn.addEventListener('click', async () => {
      if (!currentTool) {
        showError('No tool to publish');
        return;
      }

      publishBtn.disabled = true;
      errorDiv.innerHTML = '<p>Publishing tool...</p>';

      try {
        const result = await publishTool(currentTool, apiBase);
        const subdomain = result.name;
        const url = `https://${subdomain}.questit.cc/`;
        errorDiv.innerHTML = `<div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-top: 12px;">
          ✅ Tool published! Access it at: <a href="${url}" target="_blank">${url}</a>
        </div>`;
        console.log('Published:', result);
      } catch (error) {
        console.error('Publish error:', error);
        showError(`Publish error: ${error.message}`, { stack: error.stack });
      } finally {
        publishBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
