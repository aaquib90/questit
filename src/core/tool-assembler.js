import {
  createToolError,
  createToolErrorState,
  generateUniqueId,
  normalizeError
} from '../utils/helper-functions.js';

const ATTRIBUTION_COMMENT = (repoUrl, license) => `// Tool generated by Questit\n// Based on code from: ${repoUrl || 'unknown repository'}\n// License: ${license || 'Unknown'}\n// Generated on: ${new Date().toISOString()}`;

function validateAdaptedCode(adaptedCode) {
  if (!adaptedCode || typeof adaptedCode !== 'object') {
    throw createToolError('Adapted code payload is missing or invalid', {
      context: { adaptedCode }
    });
  }

  if (!adaptedCode.html && !adaptedCode.js) {
    throw createToolError('Adapted code must include at least HTML or JavaScript content.');
  }

  return true;
}

function buildRuntimeConfig(toolId) {
  return {
    version: '2025.11.05',
    toolId,
    errorHandling: {
      mode: 'inline',
      displayRetry: true,
      fallbackMessage: 'We hit a snag running this tool. Please review the details below.'
    }
  };
}

function injectAttribution(js, repoUrl, license) {
  const attribution = ATTRIBUTION_COMMENT(repoUrl, license);
  if (!js) return attribution;
  return `${attribution}\n\n${js}`.trim();
}

function createExecutionEnvelope(js) {
  if (!js) return '';

  return `(() => {\n  const questitDispatchError = (error) => {\n    const event = new CustomEvent('questit:tool-error', { detail: error });\n    window.dispatchEvent(event);\n  };\n\n  try {\n    ${js}\n  } catch (error) {\n    const payload = error && error.detail ? error.detail : error;\n    questitDispatchError({\n      message: payload?.message || 'An unexpected error occurred executing the tool.',\n      stack: payload?.stack || null\n    });\n    console.error('Questit tool execution error:', error);\n  }\n})();`;
}

export function assembleTool(adaptedCode, intent = {}, repo = {}) {
  validateAdaptedCode(adaptedCode);

  const toolId = generateUniqueId('tool');

  const tool = {
    id: toolId,
    title: adaptedCode.title || `${intent.action || 'Custom'} ${intent.category || 'Tool'}`.trim(),
    description: adaptedCode.description || '',
    instructions: adaptedCode.instructions || '',
    category: intent.category || 'general',
    action: intent.action || 'execute',
    html: adaptedCode.html || '<div class="questit-tool-output"></div>',
    css: adaptedCode.css || '',
    js: injectAttribution(adaptedCode.js || '', repo.url, repo.license),
    executionBundle: createExecutionEnvelope(adaptedCode.js || ''),
    sourceRepo: repo.url || adaptedCode.sourceRepo || null,
    license: repo.license || 'Unknown',
    createdAt: new Date(),
    expiresAt: null,
    intent,
    errorState: createToolErrorState(),
    runtime: buildRuntimeConfig(toolId)
  };

  tool.errorState.history.push({
    type: 'info',
    message: 'Tool assembled successfully',
    timestamp: new Date().toISOString()
  });

  return tool;
}

export function recordToolError(tool, error, context = {}) {
  if (!tool) return;
  const normalised = normalizeError(error, context);
  tool.errorState.hasError = true;
  tool.errorState.lastError = normalised;
  tool.errorState.history.push(normalised);
}

